from kivy.uix.scatter import ScatterPlane
from kivy.graphics.transformation import Matrix 
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.label import Label
from kivy.clock import Clock
from kivy.core.window import Window 

from util import draw_box

class SwipePlane( ScatterPlane ):
    PAGE_W, PAGE_H = Window.width, Window.height
    def __init__(self, *args, **kwargs):
        """ScatterPlane that responds to swipe gestures."""
        super(type(self), self).__init__(*args, **kwargs)
        self.do_rotation, self.do_scaling, self.do_translation_y = False, True, False
        self.pages = []
        self.animating = False#Only allow one animation loop at a time.
        self.xvel = 0
        self.display = Label( pos=(self.PAGE_W/2,0), text="", font_size=64 )
        self.add_widget( self.display )
        Window.bind(on_motion=lambda window, etype, e: self.on_motion( etype, e ) )
    
    def add_page( self ):
        x,y = len(self.pages)*self.PAGE_W, 0
        draw_box( self, (x,y), (self.PAGE_W, self.PAGE_H), (0,1,0,1), width=4 )
        page = FloatLayout( pos=(x,y), size=(self.PAGE_W, self.PAGE_H) )
        page.add_widget( Label( pos=(x, y), text=str(len(self.pages)+1), font_size=64 ))
        self.add_widget( page )
        self.pages += [page]

    def current_page(self): return int(-self.x / self.PAGE_W)

    def on_motion( self, etype, e ):
        self.display.text = str(e.dx)
        if etype == 'begin':
            self.stop_inertia()
            self.start_page_i = self.current_page()
            self.start_page = self.pages[ self.start_page_i ]
        elif etype == 'end':
            if not self.animating and not self.off_edge(e.dx): 
                self.start_inertia( e.dx )

    def off_edge(self, dx):
        "Return True if moving @dx will take the window into the black."
        return (dx > 0 and self.start_page_i == 0) or \
            (dx < 0 and self.start_page_i == len(self.pages)-1)

    def start_inertia(self, xvel):
        self.animating, self.xvel = True, xvel
        Clock.schedule_interval(self.animate, 1/120.0)

    def stop_inertia(self):
        self.animating, self.xvel = False, 0
        Clock.unschedule(self.animate)
    
    def collide_page( self, page ):
        return page != self.start_page and \
                page.x - abs(self.xvel) <= -self.x <= page.x + abs(self.xvel)

    def animate( self, dt ):
        for p in self.pages:
            if self.collide_page(p):
                self.stop_inertia()
                self.x_shift( -p.x )
                return 
        self.x += self.xvel
        self.x_shift( self.x )

    def x_shift(self, x):
        self.apply_transform( 
            self.transform.inverse().translate( x, 0, 0 )
        )
                


if __name__ == '__main__':
    from kivy.base import runTouchApp
    
    swipe_plane = SwipePlane()
    for i in range(2):
        swipe_plane.add_page()
    runTouchApp( swipe_plane )
